<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="SQLixirs">
<meta name="dcterms.date" content="2025-04-27">

<title>CASA0025 Group Project: Cranes in transit</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dd08061cb7210c315e315379d94beb87.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-dd08061cb7210c315e315379d94beb87.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-d9cd9742bc4de3f5f8badbd88ddf3d8a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-14ee88bc64474bd147d138f5c2c92101.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">CASA0025 Group Project: Cranes in transit</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/LZQ407/CASA0025_Project_Template"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://twitter.com/intent/tweet?url=|url|">
              <i class="bi bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://www.facebook.com/sharer/sharer.php?u=|url|">
              <i class="bi bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./index.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">CASA0025 - Cranes in Transit</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">CASA0025 - Cranes in Transit</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#project-summary" id="toc-project-summary" class="nav-link active" data-scroll-target="#project-summary"><span class="header-section-number">1</span> Project Summary</a>
  <ul class="collapse">
  <li><a href="#problem-statement" id="toc-problem-statement" class="nav-link" data-scroll-target="#problem-statement"><span class="header-section-number">1.1</span> Problem Statement</a></li>
  <li><a href="#end-user" id="toc-end-user" class="nav-link" data-scroll-target="#end-user"><span class="header-section-number">1.2</span> End User</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data"><span class="header-section-number">1.3</span> Data</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology"><span class="header-section-number">1.4</span> Methodology</a></li>
  <li><a href="#interface" id="toc-interface" class="nav-link" data-scroll-target="#interface"><span class="header-section-number">1.5</span> Interface</a></li>
  </ul></li>
  <li><a href="#the-application" id="toc-the-application" class="nav-link" data-scroll-target="#the-application"><span class="header-section-number">2</span> The Application</a></li>
  <li><a href="#how-it-works" id="toc-how-it-works" class="nav-link" data-scroll-target="#how-it-works"><span class="header-section-number">3</span> How it Works</a>
  <ul class="collapse">
  <li><a href="#section-a-data-setting" id="toc-section-a-data-setting" class="nav-link" data-scroll-target="#section-a-data-setting"><span class="header-section-number">3.1</span> Section A: Data Setting</a></li>
  <li><a href="#section-b-data-preprocessing" id="toc-section-b-data-preprocessing" class="nav-link" data-scroll-target="#section-b-data-preprocessing"><span class="header-section-number">3.2</span> Section B: Data Preprocessing</a></li>
  <li><a href="#section-c-utility-functions" id="toc-section-c-utility-functions" class="nav-link" data-scroll-target="#section-c-utility-functions"><span class="header-section-number">3.3</span> Section C: Utility Functions</a></li>
  <li><a href="#section-d-ui-components" id="toc-section-d-ui-components" class="nav-link" data-scroll-target="#section-d-ui-components"><span class="header-section-number">3.4</span> Section D: UI Components</a></li>
  <li><a href="#section-e-hotspot-extraction" id="toc-section-e-hotspot-extraction" class="nav-link" data-scroll-target="#section-e-hotspot-extraction"><span class="header-section-number">3.5</span> Section E: Hotspot Extraction</a></li>
  <li><a href="#section-f-ui-setting-legend" id="toc-section-f-ui-setting-legend" class="nav-link" data-scroll-target="#section-f-ui-setting-legend"><span class="header-section-number">3.6</span> Section F: UI Setting &amp; Legend</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">4</span> References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CASA0025 Group Project: Cranes in transit</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>SQLixirs </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 27, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="project-summary" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Project Summary</h1>
<p>This application identifies and maps critical habitat-use hotspots of the migratory White-naped Crane across East Asia, placing special emphasis on gotspots outside formal nature reserves, and evaluates their ecological condition. By integrating GPS tracking data with environmental indicators of vegetation, temperature, pollution and water availability, it provides conservation practitioners with robust evidence to protect off-reserve crane habitats. Built on Google Earth Engine, the tool offers an intuitive interface that lets users define any region along the migration corridor and explore seasonal and spatial patterns of crane-density hotspots and their habitat quality.</p>
<section id="problem-statement" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="problem-statement"><span class="header-section-number">1.1</span> Problem Statement</h2>
<p>The White-naped Crane (Grus vipio) depends on a network of seasonal habitats across East Asia, yet many critical stopover and staging sites lie outside formal nature reserves. These off-reserve areas are highly vulnerable to agricultural expansion, urban development, and climate change (Wilcove &amp; Wikelski, 2008). Because they are seasonally used and scattered across jurisdictions, conservationists struggle to gather precise evidence needed for protection (Yanco et al., 2024; Runge et al., 2014). Our application addresses this gap by identifying and evaluating crane hotspots beyond existing reserves to support broader habitat conservation.</p>
</section>
<section id="end-user" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="end-user"><span class="header-section-number">1.2</span> End User</h2>
<p>Our application is designed for conservationists and environmental NGOs who seek to protect migratory bird habitats, especially off-reserve stopover and staging areas. These users often struggle to communicate the ecological significance of dynamic, short-lived sites to government bodies (Rose et al., 2018). By combining animal movement data with seasonal environmental indicators, our tool enables users to extract spatial evidence that supports off-reserve conservation claims. This helps bridge the gap between scientific data and policy advocacy, empowering practitioners to argue more effectively for new or extended habitat protections.</p>
</section>
<section id="data" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="data"><span class="header-section-number">1.3</span> Data</h2>
<p>We integrate multi-source remote sensing and ecological tracking datasets. White-naped Crane movement data comes from the “White-naped Crane Mongolia WSCC” study (Batbayar et al., 2024), which provides high-resolution GPS data via the Movebank Repository. Environmental conditions are assessed using MODIS NDVI for vegetation, ERA5 for temperature, Sentinel-5P for pollution levels, and JRC for inland water extent. Nature reserve boundaries are sourced from the Protected Planet database, which provides information of protected areas under global standards. This integrated dataset enables the identification of high-density crane-use hotspots and then the precise, spatiotemporal quantification of environmental quality within those hotspots along the migratory corridor.</p>
</section>
<section id="methodology" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="methodology"><span class="header-section-number">1.4</span> Methodology</h2>
<p>Crane hotspots are extracted by summing GPS-tagged point counts and convolving them with a Gaussian kernel (10 km radius, σ = 10 km) to produce a smooth density surface. Pixels above a user-defined percentile threshold are masked, passed through a 50 m focal-maximum filter, and vectorized into polygons representing hotspots. Hotspots are classified into two categories: fully inside reserves or intersecting/outside reserves, with reserve overlap percentage calculated. Finally, the crane peak season is identified based on the tracking data distribution across four seasons, and mean values of NDVI, 2 m air temperature, tropospheric NO₂ concentration, and water-area fraction is retrieved for that peak season, which will help end users asses habitat quality.</p>
</section>
<section id="interface" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="interface"><span class="header-section-number">1.5</span> Interface</h2>
<p>Built on Google Earth Engine, this application provides an interactive platform for conservation practitioners to explore crane hotspots. First, users select a target country and province, customize a density threshold, and view hotspots displayed in two layers: fully outside reserves (red) and intersecting or inside reserves (orange). Next, clicking any hotspot opens a panel showing the percentage of its area within nature reserves, the peak crane season, and that season’s average vegetation (NDVI), temperature, NO₂ pollution, and water‐area fraction. These intuitive steps transform complex spatiotemporal data into clear, actionable evidence for off‐reserve crane habitat protection.</p>
</section>
</section>
<section id="the-application" class="level1 page-columns page-full" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> The Application</h1>
<p>You can explore the application below or access it directly through this link: <a href="https://casa25gw.projects.earthengine.app/view/cranes-in-transit">Cranes in transit app</a></p>
<div class="column-page">
<iframe src="https://casa25gw.projects.earthengine.app/view/cranes-in-transit" width="100%" height="700px">
</iframe>
</div>
</section>
<section id="how-it-works" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> How it Works</h1>
<section id="section-a-data-setting" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="section-a-data-setting"><span class="header-section-number">3.1</span> Section A: Data Setting</h2>
<p>The application centers and initializes a map in ‘SATELLITE’ mode for geographic context.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A1: Map Initialization</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="dv">108</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">'SATELLITE'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A cleaned crane tracking <code>FeatureCollection</code> incorporates timestamps via <code>system:time_start</code> to enable temporal filtering. Supplementary vector layers include crane migration corridors, natural reserves, and clipped administrative boundaries (<code>countries</code>, <code>provinces</code>).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A2: Data Imports &amp; Preprocessing</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cranes <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/casa25gw/assets/cleaned_crane_below100'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">'system:time_start'</span><span class="op">,</span> f<span class="op">.</span><span class="fu">get</span>(<span class="st">'timestamp'</span>))<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> convex_hull <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/casa25gw/assets/convex_hull_'</span>)<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> convex_hull_s <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/casa25gw/assets/convex_hull_smooth'</span>)<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> natural_reserves <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'projects/casa25gw/assets/natural_reserves'</span>)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> countries <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'FAO/GAUL_SIMPLIFIED_500m/2015/level0'</span>)<span class="op">.</span><span class="fu">filterBounds</span>(convex_hull)<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> provinces <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">'FAO/GAUL_SIMPLIFIED_500m/2015/level1'</span>)<span class="op">.</span><span class="fu">filterBounds</span>(convex_hull)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Global placeholders track UI state and seasonal filters. A dictionary mapping <code>seasons</code> is created to support later seasonal aggregation.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A3: Global Variable Declarations</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hotspotsSimplified<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> insideLayer<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> outsideLayer<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> enrichedHotspots<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hotspotLayer<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> reserveClass<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> threshold_value <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> onCountryChange<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> onProvinceChange<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hotspotCountLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">''</span><span class="op">,</span> {</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> <span class="st">'gray'</span><span class="op">,</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'11px'</span><span class="op">,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">margin</span><span class="op">:</span> <span class="st">'8px 8px 8px 8px'</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> seasons <span class="op">=</span> {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Winter</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">or</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">12</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="st">'month'</span>))<span class="op">,</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Spring</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">,</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Summer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">6</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="st">'month'</span>)<span class="op">,</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Autumn</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">9</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="st">'month'</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> seasonNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">'Winter'</span><span class="op">,</span> <span class="st">'Spring'</span><span class="op">,</span> <span class="st">'Summer'</span><span class="op">,</span> <span class="st">'Autumn'</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>2018-2021 collections of the four environmental datasets: NDVI (MODIS), air temperature (ERA5), tropospheric NO2 (Sentinel-5P), and water presence (JRC Monthly History) are filtered.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A4: Load Environmental layers</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> envStart <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">'2018-01-01'</span>)<span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    envEnd <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">'2021-12-31'</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'MODIS/061/MOD13A1'</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(envStart<span class="op">,</span> envEnd)<span class="op">.</span><span class="fu">select</span>(<span class="st">'NDVI'</span>)<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> tempCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'ECMWF/ERA5/DAILY'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(envStart<span class="op">,</span> envEnd)<span class="op">.</span><span class="fu">select</span>(<span class="st">'mean_2m_air_temperature'</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> no2Col <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'COPERNICUS/S5P/OFFL/L3_NO2'</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(envStart<span class="op">,</span> envEnd)<span class="op">.</span><span class="fu">select</span>(<span class="st">'tropospheric_NO2_column_number_density'</span>)<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'JRC/GSW1_4/MonthlyHistory'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(envStart<span class="op">,</span> envEnd)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-b-data-preprocessing" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="section-b-data-preprocessing"><span class="header-section-number">3.2</span> Section B: Data Preprocessing</h2>
<p>The <code>safeMeanWithFallback</code> function computes seasonal means, defaulting to annual means if insufficient data exists, ensuring every season has valid data.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// B1: Function to get the mean by season by total time span</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">safeMeanWithFallback</span>(seasonCol<span class="op">,</span> annualCol) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        seasonCol<span class="op">.</span><span class="fu">size</span>()<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)<span class="op">,</span> seasonCol<span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> annualCol<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    ))<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> annual <span class="op">=</span> {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NDVI</span><span class="op">:</span> ndviCol<span class="op">,</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Temp</span><span class="op">:</span> tempCol<span class="op">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">NO2</span><span class="op">:</span> no2Col</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>NDVI and temperature units are rescaled, with bands renamed/clipped to the migration corridor. Precomputing these composites optimizes later queries by reducing each time series to four seasonal images.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// B2: Get Seasonal data from NDVI, Temperature and Pollution Layers </span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> envComposites <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({})<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>seasonNames<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(season) {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    envComposites <span class="op">=</span> envComposites<span class="op">.</span><span class="fu">set</span>(season<span class="op">,</span> {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">NDVI</span><span class="op">:</span> <span class="fu">safeMeanWithFallback</span>(ndviCol<span class="op">.</span><span class="fu">filter</span>(seasons[season])<span class="op">,</span> annual<span class="op">.</span><span class="at">NDVI</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NDVI'</span>)<span class="op">.</span><span class="fu">clip</span>(convex_hull)<span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Temp</span><span class="op">:</span> <span class="fu">safeMeanWithFallback</span>(tempCol<span class="op">.</span><span class="fu">filter</span>(seasons[season])<span class="op">,</span> annual<span class="op">.</span><span class="at">Temp</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">'Temp'</span>)<span class="op">.</span><span class="fu">clip</span>(convex_hull)<span class="op">,</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">NO2</span><span class="op">:</span> <span class="fu">safeMeanWithFallback</span>(no2Col<span class="op">.</span><span class="fu">filter</span>(seasons[season])<span class="op">,</span> annual<span class="op">.</span><span class="at">NO2</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">rename</span>(<span class="st">'NO2'</span>)<span class="op">.</span><span class="fu">clip</span>(convex_hull)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Water masks identify permanent water (JRC class 2) per season (<code>water == 2</code>), calculating hotspot water coverage percentages.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// B3: Get seasonal data of water proportion </span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMaskComposites <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({})<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>seasonNames<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span>(seasonName) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> wm <span class="op">=</span> waterCol</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(seasons[seasonName])        </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(img) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> img<span class="op">.</span><span class="fu">select</span>(<span class="st">'water'</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">;</span> </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">max</span>()                               </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">rename</span>(<span class="st">'WaterMask'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(convex_hull)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  waterMaskComposites <span class="op">=</span> waterMaskComposites<span class="op">.</span><span class="fu">set</span>(seasonName<span class="op">,</span> wm)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Country borders, nature reserves, and the corridor are styled and added to the core map layer.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// B4: Core Map Layers Styling</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> reservesLayer <span class="op">=</span> natural_reserves<span class="op">.</span><span class="fu">style</span>({ <span class="dt">color</span><span class="op">:</span> <span class="st">'#006400'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#00640088'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> countriesLayer <span class="op">=</span> countries<span class="op">.</span><span class="fu">style</span>({ <span class="dt">color</span><span class="op">:</span> <span class="st">'black'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#cccccc00'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="fl">1.8</span> })<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> corridorLayer <span class="op">=</span> convex_hull_s<span class="op">.</span><span class="fu">style</span>({ <span class="dt">color</span><span class="op">:</span> <span class="st">'cccccc30'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#cccccc25'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(reservesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Nature Reserves'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(countriesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Country Borders'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(corridorLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Migration Corridor'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-c-utility-functions" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="section-c-utility-functions"><span class="header-section-number">3.3</span> Section C: Utility Functions</h2>
<p><code>getBestZoomLevel</code> measures the maximum latitude/longitude span of the selected region bounds and maps it to one of five preset zoom levels.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// C1: Compute Optimal Zoom Level</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getBestZoomLevel</span>(bounds) {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> coords  <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(bounds<span class="op">.</span><span class="fu">coordinates</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> lats    <span class="op">=</span> coords<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(c) { <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(ee<span class="op">.</span><span class="fu">List</span>(c)<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>))<span class="op">;</span> })<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> lngs    <span class="op">=</span> coords<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(c) { <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(ee<span class="op">.</span><span class="fu">List</span>(c)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span> })<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> latDiff <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(lats<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()))<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(lats<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>())))<span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> lngDiff <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(lngs<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()))<span class="op">.</span><span class="fu">subtract</span>(ee<span class="op">.</span><span class="fu">Number</span>(lngs<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>())))<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxDiff <span class="op">=</span> latDiff<span class="op">.</span><span class="fu">max</span>(lngDiff)<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(maxDiff<span class="op">.</span><span class="fu">gt</span>(<span class="dv">150</span>)<span class="op">,</span><span class="fl">3.5</span><span class="op">,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>         ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(maxDiff<span class="op">.</span><span class="fu">gt</span>(<span class="dv">50</span>)<span class="op">,</span> <span class="fl">4.5</span><span class="op">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>         ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(maxDiff<span class="op">.</span><span class="fu">gt</span>(<span class="dv">30</span>)<span class="op">,</span> <span class="fl">5.3</span><span class="op">,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>         ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(maxDiff<span class="op">.</span><span class="fu">gt</span>(<span class="dv">15</span>)<span class="op">,</span> <span class="fl">5.9</span><span class="op">,</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>         ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(maxDiff<span class="op">.</span><span class="fu">gt</span>(<span class="dv">7</span>)<span class="op">,</span>  <span class="fl">6.8</span><span class="op">,</span><span class="fl">7.5</span>)))))<span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>updateHotspotCount</code> filters <code>hotspotSimplified</code> by the given region, evaluates the count of hotspots, and show the number of matching hotspots in the slider panel.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// C2: Update Hotspot Count Display</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateHotspotCount</span>(geometry) {</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hotspotsSimplified <span class="op">&amp;&amp;</span> geometry) {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">filterBounds</span>(geometry)<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">size</span>()<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(count) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (count <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        hotspotCountLabel<span class="op">.</span><span class="fu">setValue</span>(count <span class="op">+</span> <span class="st">' HOTSPOTS MATCH THE FILTERING CRITERIA.'</span>)<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        hotspotCountLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'NO HOTSPOTS FOUND. TRY A LOWER VALUE OR CHANGE REGION.'</span>)<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    hotspotCountLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">'SOMETHING WENT WRONG. PLEASE RESET.'</span>)<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>renderHotspotLayers</code> classifies each hotspot as “(partially) inside” or “outside” of reserves and then adds two styled map layers (red for outside, orange for inside).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// C3: Render Hotspot Layers by Reserve Class</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">renderHotspotLayers</span>(collection<span class="op">,</span> namePrefix) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">//create an inside/outside variable for each hotspot</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> hotspotsSimplified <span class="op">=</span> collection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(feature) {</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> reserveClass <span class="op">=</span> feature<span class="op">.</span><span class="fu">get</span>(<span class="st">'reserveClass'</span>)<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> newClass <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="fu">String</span>(reserveClass)<span class="op">.</span><span class="fu">equals</span>(<span class="st">'outside'</span>)<span class="op">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">'outside'</span><span class="op">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">'inside'</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> feature<span class="op">.</span><span class="fu">set</span>(<span class="st">'newReserveClass'</span><span class="op">,</span> newClass)<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> outside <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'newReserveClass'</span><span class="op">,</span> <span class="st">'outside'</span>))<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> inside  <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'newReserveClass'</span><span class="op">,</span> <span class="st">'inside'</span>))<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(outside<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">'#FF0000'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#FF000088'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">,</span> namePrefix <span class="op">+</span> <span class="st">' Outside Reserves'</span>)<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(inside<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">'#ff8c00'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#ff8c0088'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">,</span> namePrefix <span class="op">+</span> <span class="st">' Intersecting Reserves'</span>)<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-d-ui-components" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="section-d-ui-components"><span class="header-section-number">3.4</span> Section D: UI Components</h2>
<p>The main control panel provides the app title and serves as a dynamic container for all sub-panels.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D1: Main Control Panel</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span>       <span class="st">'middle-left'</span><span class="op">,</span>       </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">padding</span><span class="op">:</span>        <span class="st">'8px'</span><span class="op">,</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">backgroundColor</span><span class="op">:</span><span class="st">'white'</span><span class="op">,</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">border</span><span class="op">:</span>         <span class="st">'1px solid #666'</span><span class="op">,</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">borderRadius</span><span class="op">:</span>   <span class="st">'6px'</span><span class="op">,</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span>          <span class="st">'360px'</span><span class="op">,</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxHeight</span><span class="op">:</span>      <span class="st">'80%'</span>            </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Mapping Crane Density Hotspots to Guide Off‑Reserve Conservation'</span><span class="op">,</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'20px'</span> }  ))<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The density slider panel houses the 1-100 percentile slider, explanatory labels, and the hotspot count label for real-time filtering.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D2: Density Slider Sub-Panel</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sliderPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">'middle-left'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'8px'</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">'white'</span><span class="op">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">border</span><span class="op">:</span> <span class="st">'1px solid #666'</span><span class="op">,</span> <span class="dt">borderRadius</span><span class="op">:</span> <span class="st">'6px'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="st">'360px'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'10px 0 0 8px'</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>sliderPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Set hotspots density percentile'</span><span class="op">,</span> {</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'14px'</span><span class="op">,</span><span class="dt">margin</span><span class="op">:</span> <span class="st">'6px 0px 0px 6px'</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>sliderPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Higher slider values display progressively denser hotspots</span><span class="sc">\n</span><span class="st">(1 = areas at the 99th percentile; 100 = only the highest-density areas).'</span><span class="op">,</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">'normal'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'12px'</span><span class="op">,</span><span class="dt">margin</span><span class="op">:</span> <span class="st">'4px 0px 6px 6px'</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">'#3b3b3b'</span><span class="op">,</span> <span class="dt">whiteSpace</span><span class="op">:</span> <span class="st">'pre-line'</span>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> percentileSlider <span class="op">=</span> ui<span class="op">.</span><span class="fu">Slider</span>({</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> threshold_value<span class="op">,</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span>}</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>sliderPanel<span class="op">.</span><span class="fu">add</span>(percentileSlider)<span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>sliderPanel<span class="op">.</span><span class="fu">add</span>(hotspotCountLabel)<span class="op">;</span>  </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(sliderPanel)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>homeButton</code> and <code>resetButton</code> buttons are created to restore the map view, panel layout, and slider/selection values to their defaults in one click.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D3: Home Button</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> homeButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Home'</span><span class="op">,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> { <span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'20px 8px 8px 8px'</span> }<span class="op">,</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(infoPanel)<span class="op">;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(statisticsPanel)<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(descriptionPanel)<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">add</span>(descriptionPanel)<span class="op">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(regionPanel)<span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">add</span>(regionPanel)<span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(homeButton)<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    countrySelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>([<span class="st">'(No provinces)'</span>])<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    percentileSlider<span class="op">.</span><span class="fu">setValue</span>(<span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(reservesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Nature Reserves'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(countriesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Country borders'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(corridorLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Migration corridor'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="dv">108</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">'SATELLITE'</span>)<span class="op">;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(sliderPanel)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(sliderPanel)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateHotspotsFromSlider</span>(<span class="dv">1</span>)<span class="op">;</span>    </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co">// D4: Reset Button</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> resetButton <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">'Reset'</span><span class="op">,</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">'horizontal'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">'20px 8px 8px 8px'</span>}<span class="op">,</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">onClick</span><span class="op">:</span> <span class="kw">function</span>() {</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    countrySelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>([<span class="st">'(Select a country first)'</span>])<span class="op">;</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">setValue</span>(<span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    percentileSlider<span class="op">.</span><span class="fu">setValue</span>(<span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(reservesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Nature Reserves'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(countriesLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Country borders'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(corridorLayer<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Migration corridor'</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="dv">108</span><span class="op">,</span> <span class="dv">40</span><span class="op">,</span> <span class="dv">4</span>)<span class="op">;</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">'SATELLITE'</span>)<span class="op">;</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    mainPanel<span class="op">.</span><span class="fu">remove</span>(homeButton)<span class="op">;</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateHotspotsFromSlider</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>infoPanel</code> and <code>statisticsPanel</code> define hotspot attribute descriptions (crane peak season, total crane counts, reserve coverage status, NDVI, temperature, NO2, water area fraction) and display actual values (via <code>addInfoRow</code>) when a hotspot is clicked.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D5: Environmental Information Panel</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> infoPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({ <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>) })<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Step 2: Retrieve Hotspot Info'</span><span class="op">,</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fontWeight</span><span class="op">:</span> <span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'18px'</span> }</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Click any hotspot to retrieve its crane peak season, total cranes detected, and four important environmental components relevant to their habitats (Batbayar et al., 2024).'</span><span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">whiteSpace</span><span class="op">:</span> <span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'12px'</span> }</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Peak Season:'</span><span class="op">,</span>      { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Season with maximum crane density in the hotspot.'</span><span class="op">,</span> { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Total Cranes:'</span><span class="op">,</span>      { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Number of crane observations recorded in the hotspot.'</span><span class="op">,</span> { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Reserve coverage (%):'</span><span class="op">,</span>      { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Percentage of hotspot area inside a protected nature reserve.'</span><span class="op">,</span> { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Average NDVI:'</span><span class="op">,</span>     { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Mean NDVI during peak season (2018–2021).'</span><span class="op">,</span> { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Average Temp (°C):'</span><span class="op">,</span>{ <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Mean 2 m air temperature during peak season (2018–2021).'</span><span class="op">,</span>{ <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Average NO₂:'</span><span class="op">,</span>      { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Mean tropospheric NO₂ column density during peak season (2018–2021).'</span><span class="op">,</span>{ <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Water Area (%):'</span><span class="op">,</span>   { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>infoPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Percentage of hotspot polygon area classified as water during its peak season.'</span><span class="op">,</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">// D6: Hotspot Statistics Panel</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> statisticsPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({ <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>) })<span class="op">;</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>statisticsPanel<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minHeight</span><span class="op">:</span> <span class="st">'100px'</span><span class="op">,</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">padding</span><span class="op">:</span> <span class="st">'10px'</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addInfoRow</span>(name<span class="op">,</span> widget) {</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  statisticsPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Panel</span>([</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(name <span class="op">+</span> <span class="st">':'</span><span class="op">,</span> { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> })<span class="op">,</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    widget</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'horizontal'</span>)))<span class="op">;</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>descriptionPanel</code> shows the app’s goal and data span in text, plus a hyperlink to the crane dataset.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D7: App Description Sub-Panel</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> descriptionPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({ <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span> <span class="dt">style</span><span class="op">:</span> { <span class="dt">margin</span><span class="op">:</span><span class="st">'8px 0 0 0'</span> }})<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>descriptionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'This application maps high‑density crane hotspots, many of which lie outside formally protected reserves, to inform off‑reserve conservation planning by displaying each hotspot’s peak‑season environmental drivers of habitat suitability. The dataset spans August&nbsp;2013 through April&nbsp;2021.'</span><span class="op">,</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span><span class="st">'gray'</span><span class="op">,</span> <span class="dt">fontStyle</span><span class="op">:</span><span class="st">'italic'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'13px'</span> }</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>descriptionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Click here for the crane source data (Batbayar et&nbsp;al.&nbsp;2024)'</span><span class="op">,</span> {</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fontSize</span><span class="op">:</span> <span class="st">'12px'</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">'blue'</span><span class="op">,</span> <span class="dt">fontStyle</span><span class="op">:</span> <span class="st">'italic'</span><span class="op">,</span> <span class="dt">textDecoration</span><span class="op">:</span> <span class="st">'underline'</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="st">'https://datarepository.movebank.org/entities/datapackage/1e31df42-edfa-4225-b923-d8b0de83ab20'</span>))<span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(descriptionPanel)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>regionPanel</code> contains country/province dropdowns (with <code>onChange</code> callbacks), labels, and the Reset button to guide users through the region selection.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// D8: Region Selection Handlers (Stubs)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> countrySelect  <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({ <span class="dt">placeholder</span><span class="op">:</span><span class="st">'Select Country'</span> })<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> provinceSelect <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({ <span class="dt">placeholder</span><span class="op">:</span><span class="st">'Select Province'</span> })<span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">// D9: Region Selector Panel</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> regionPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'vertical'</span>)<span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> { <span class="dt">margin</span><span class="op">:</span><span class="st">'8px 0 0 0'</span> }</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Step&nbsp;1: Select Your Region'</span><span class="op">,</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'14px'</span> }</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Choose a country and a province to zoom in. Layers may take up to one minute to fully process after each click.'</span><span class="op">,</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">whiteSpace</span><span class="op">:</span><span class="st">'wrap'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Country:'</span><span class="op">,</span>  { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(countrySelect)<span class="op">;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Province:'</span><span class="op">,</span> { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'12px'</span> }))<span class="op">;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(provinceSelect)<span class="op">;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>regionPanel<span class="op">.</span><span class="fu">add</span>(resetButton)<span class="op">;</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(regionPanel)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-e-hotspot-extraction" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="section-e-hotspot-extraction"><span class="header-section-number">3.5</span> Section E: Hotspot Extraction</h2>
<p>Crane point counts (count = 1) are rasterized via <code>reduceToImage</code> and then convolved with a Gaussian kernel of radius 10 km and σ = 10 km to produce a smooth density surface. In continuous form, the weighting follows: <span class="math display">\[
K(d) = \frac{1}{\sqrt{2\pi}\,\sigma}\exp\!\Bigl(-\frac{d^2}{2\sigma^2}\Bigr),
\]</span><br>
This ensures that observations contribute most strongly near their true location and taper off smoothly.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// E1: Density Image Creation</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">gaussian</span>({</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">radius</span><span class="op">:</span> <span class="dv">10000</span><span class="op">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sigma</span><span class="op">:</span> <span class="dv">10000</span><span class="op">,</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">units</span><span class="op">:</span> <span class="st">'meters'</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> densityImage <span class="op">=</span> cranes</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">'count'</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduceToImage</span>([<span class="st">'count'</span>]<span class="op">,</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">convolve</span>(kernel)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reproject</span>(<span class="st">'EPSG:4326'</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">1000</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(convex_hull)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Country/province selection resets layers, zooms to the regional bounds (with borders and reserves redrawn), then filters and renders <code>hotspotsSimplified</code> within it.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// E2: Country-Based Filtering Handler</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>onCountryChange <span class="op">=</span> <span class="kw">function</span>(countryName) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedCountryFeatures <span class="op">=</span> countries<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> countryName))<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateHotspotCount</span>(selectedCountryFeatures)<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> provs <span class="op">=</span> provinces</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> countryName))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'ADM1_NAME'</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">distinct</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>()<span class="op">;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  provs<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(list) {</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    provinceSelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>(list<span class="op">.</span><span class="at">length</span> <span class="op">?</span> list <span class="op">:</span> [<span class="st">'(No provinces)'</span>])<span class="op">;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bounds <span class="op">=</span> selectedCountryFeatures<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getBestZoomLevel</span>(bounds)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(z) {</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(bounds<span class="op">,</span> z)<span class="op">;</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(selectedCountryFeatures<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> <span class="st">'black'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#cccccc05'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span> {}<span class="op">,</span> countryName <span class="op">+</span> <span class="st">' Border'</span>))<span class="op">;</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(natural_reserves<span class="op">.</span><span class="fu">filterBounds</span>(selectedCountryFeatures)<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> <span class="st">'#006400'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#00640075'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span> {}<span class="op">,</span> countryName <span class="op">+</span><span class="st">' Nature Reserves'</span>))<span class="op">;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> provincesSelected <span class="op">=</span> provinces<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> countryName))<span class="op">;</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedCountryGeometry <span class="op">=</span> provincesSelected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">dissolve</span>()<span class="op">;</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(provincesSelected<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> <span class="st">'black'</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#cccccc15'</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span> {}<span class="op">,</span> <span class="st">'Provinces within migration corridor'</span>))<span class="op">;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (outsideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(outsideLayer)<span class="op">;</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (insideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(insideLayer)<span class="op">;</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hotspotsSimplified) {</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filteredHotspots <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">filterBounds</span>(selectedCountryGeometry)<span class="op">;</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">renderHotspotLayers</span>(filteredHotspots<span class="op">,</span> <span class="st">'Filtered Hotspots'</span>)<span class="op">;</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co">// E3: Province-Based Filtering Handler</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>onProvinceChange <span class="op">=</span> <span class="kw">function</span>(provinceName) {</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">'cursor'</span><span class="op">,</span> <span class="st">'crosshair'</span>)<span class="op">;</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (provinceName <span class="op">===</span> <span class="st">'(No provinces)'</span>) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()<span class="op">;</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(regionPanel)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(descriptionPanel)</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(infoPanel)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">add</span>(infoPanel)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(homeButton)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">add</span>(homeButton)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedProvince <span class="op">=</span> provinces<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM1_NAME'</span><span class="op">,</span> provinceName)</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bounds <span class="op">=</span> selectedProvince<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getBestZoomLevel</span>(bounds)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(z) {</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(bounds<span class="op">,</span> z)<span class="op">;</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateHotspotCount</span>(selectedProvince<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> countryName <span class="op">=</span> selectedProvince<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">'ADM0_NAME'</span>)<span class="op">;</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedCountryFeatures <span class="op">=</span> countries<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> countryName)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    selectedCountryFeatures<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'#333333'</span><span class="op">,</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'00000000'</span><span class="op">,</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    {}<span class="op">,</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    countrySelect<span class="op">.</span><span class="fu">getValue</span>() <span class="op">+</span> <span class="st">' Border'</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>  ))<span class="op">;</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    provinces<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> countryName))<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'#0f0f0f'</span><span class="op">,</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#dddddd00'</span><span class="op">,</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    {}<span class="op">,</span></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Other Provinces'</span></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>  ))<span class="op">;</span></span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    natural_reserves<span class="op">.</span><span class="fu">filterBounds</span>(selectedProvince)<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'#006400'</span><span class="op">,</span></span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#00640075'</span><span class="op">,</span></span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    {}<span class="op">,</span></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Nature Reserves'</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>  ))<span class="op">;</span></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>    selectedProvince<span class="op">.</span><span class="fu">style</span>({</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>      <span class="dt">color</span><span class="op">:</span> <span class="st">'black'</span><span class="op">,</span></span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fillColor</span><span class="op">:</span> <span class="st">'#cccccc20'</span><span class="op">,</span></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>    {}<span class="op">,</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>    provinceName <span class="op">+</span> <span class="st">' Border'</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>  ))<span class="op">;</span></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (outsideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(outsideLayer)<span class="op">;</span></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (insideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(insideLayer)<span class="op">;</span></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (hotspotsSimplified) {</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filteredHotspots <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">filterBounds</span>(selectedProvince)<span class="op">;</span></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">renderHotspotLayers</span>(filteredHotspots<span class="op">,</span> <span class="st">'Filtered Hotspots'</span>)<span class="op">;</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the percentile slider changes, the code computes a new density threshold on the smoothed crane-density image for the selected region, vectorizes to polygons, classifies each by reserve coverage, enriches with crane counts plus peak-season NDVI, temperature, NO2, and water-area metrics.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// E4: Percentile-Based Hotspot Generation</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>percentileSlider<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(val) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">updateHotspotsFromSlider</span>(val)<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">updateHotspotsFromSlider</span>(clientValue) {</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.1: Read slider value</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  threshold_value <span class="op">=</span> clientValue<span class="op">;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.2: Determine region geometry</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> convex_hull<span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selectedProvince <span class="op">=</span> provinceSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (selectedProvince <span class="op">&amp;&amp;</span> selectedProvince <span class="op">!==</span> <span class="st">'(No provinces)'</span>) {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    region <span class="op">=</span> provinces<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM1_NAME'</span><span class="op">,</span> selectedProvince))<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> selectedCountry <span class="op">=</span> countrySelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (selectedCountry) {</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      region <span class="op">=</span> countries<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> selectedCountry))<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.3: Compute density threshold</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> transformedPercentile <span class="op">=</span> <span class="dv">100</span> <span class="op">-</span> ((<span class="dv">100</span> <span class="op">-</span> threshold_value) <span class="op">/</span> <span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> newThreshold <span class="op">=</span> densityImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">percentile</span>([transformedPercentile])<span class="op">,</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">getNumber</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.4: Extract and classify hotspot polygons</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  hotspotsSimplified <span class="op">=</span> densityImage</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(region)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">gte</span>(newThreshold)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduceResolution</span>({ <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span> <span class="dt">maxPixels</span><span class="op">:</span> <span class="dv">1024</span> })</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">focal_max</span>({ <span class="dt">radius</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span> <span class="dt">units</span><span class="op">:</span> <span class="st">'meters'</span> })</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geometry</span><span class="op">:</span> convex_hull<span class="op">,</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">scale</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">geometryType</span><span class="op">:</span> <span class="st">'polygon'</span><span class="op">,</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>      <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>      <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> geom <span class="op">=</span> f<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> areaTotal <span class="op">=</span> geom<span class="op">.</span><span class="fu">area</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> inter <span class="op">=</span> natural_reserves<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(r) { <span class="cf">return</span> r<span class="op">.</span><span class="fu">intersection</span>(geom<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span> })</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>                                  <span class="op">.</span><span class="fu">union</span>()<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> areaInter <span class="op">=</span> inter<span class="op">.</span><span class="fu">area</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> perc <span class="op">=</span> areaInter<span class="op">.</span><span class="fu">divide</span>(areaTotal)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> reserveClass <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>        ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(perc<span class="op">.</span><span class="fu">lte</span>(<span class="dv">5</span>)<span class="op">,</span> <span class="st">'outside'</span><span class="op">,</span> <span class="st">'inside'</span>)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>      )<span class="op">;</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>({ <span class="dt">reserveCoverage</span><span class="op">:</span> perc<span class="op">,</span> <span class="dt">reserveClass</span><span class="op">:</span> reserveClass })<span class="op">.</span><span class="fu">simplify</span>(<span class="dv">2000</span>)<span class="op">;</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.5: Enrich with crane counts, env metrics &amp; spatial water‐area</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  enrichedHotspots <span class="op">=</span> hotspotsSimplified<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(poly) {</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> g <span class="op">=</span> poly<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> regionCranes <span class="op">=</span> cranes<span class="op">.</span><span class="fu">filterBounds</span>(g)<span class="op">;</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> counts <span class="op">=</span> seasonNames<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(s) {</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> regionCranes<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="fu">Dictionary</span>(seasons)<span class="op">.</span><span class="fu">get</span>(s))<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> peak   <span class="op">=</span> seasonNames<span class="op">.</span><span class="fu">get</span>(</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>                   ee<span class="op">.</span><span class="fu">List</span>(counts)<span class="op">.</span><span class="fu">indexOf</span>(ee<span class="op">.</span><span class="fu">List</span>(counts)<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()))</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>                 )<span class="op">;</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> total  <span class="op">=</span> regionCranes<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> inRes  <span class="op">=</span> natural_reserves<span class="op">.</span><span class="fu">filterBounds</span>(g)<span class="op">.</span><span class="fu">size</span>()<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> env <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(envComposites<span class="op">.</span><span class="fu">get</span>(peak))<span class="op">;</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> ndvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(env<span class="op">.</span><span class="fu">get</span>(<span class="st">'NDVI'</span>))<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> g<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">get</span>(<span class="st">'NDVI'</span>)<span class="op">;</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> temp <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(env<span class="op">.</span><span class="fu">get</span>(<span class="st">'Temp'</span>))<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> g<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">get</span>(<span class="st">'Temp'</span>)<span class="op">;</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> no2  <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(env<span class="op">.</span><span class="fu">get</span>(<span class="st">'NO2'</span>))<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> <span class="dt">geometry</span><span class="op">:</span> g<span class="op">,</span> <span class="dt">scale</span><span class="op">:</span> <span class="dv">1000</span><span class="op">,</span> <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">get</span>(<span class="st">'NO2'</span>)<span class="op">;</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> waterMaskImg <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>      ee<span class="op">.</span><span class="fu">Dictionary</span>(waterMaskComposites)<span class="op">.</span><span class="fu">get</span>(peak)</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> waterAreaFrac <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>      waterMaskImg<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>        <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>        <span class="dt">geometry</span><span class="op">:</span> g<span class="op">,</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>        <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>      })<span class="op">.</span><span class="fu">get</span>(<span class="st">'WaterMask'</span>)   </span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    )<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> poly<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>      <span class="dt">peakSeason</span><span class="op">:</span>    peak<span class="op">,</span></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>      <span class="dt">totalCranes</span><span class="op">:</span>   total<span class="op">,</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>      <span class="dt">inReserve</span><span class="op">:</span>     inRes<span class="op">,</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>      <span class="dt">NDVI</span><span class="op">:</span>          ndvi<span class="op">,</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Temp</span><span class="op">:</span>          temp<span class="op">,</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>      <span class="dt">NO2</span><span class="op">:</span>           no2<span class="op">,</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>      <span class="dt">WaterAreaFrac</span><span class="op">:</span> waterAreaFrac</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">setGeometry</span>(g<span class="op">.</span><span class="fu">transform</span>(<span class="st">'EPSG:4326'</span><span class="op">,</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">// E4.6: Render layers &amp; update hotspot count</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (outsideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(outsideLayer)<span class="op">;</span></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (insideLayer) <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(insideLayer)<span class="op">;</span></span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">renderHotspotLayers</span>(hotspotsSimplified<span class="op">,</span> <span class="st">'Filtered Hotspots'</span>)<span class="op">;</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selProv <span class="op">=</span> provinceSelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (selProv <span class="op">&amp;&amp;</span> selProv <span class="op">!==</span> <span class="st">'(No provinces)'</span>) {</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">updateHotspotCount</span>(provinces<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM1_NAME'</span><span class="op">,</span> selProv))<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> selCtr <span class="op">=</span> countrySelect<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (selCtr) {</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateHotspotCount</span>(countries<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">'ADM0_NAME'</span><span class="op">,</span> selCtr))<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">updateHotspotCount</span>(convex_hull<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="section-f-ui-setting-legend" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="section-f-ui-setting-legend"><span class="header-section-number">3.6</span> Section F: UI Setting &amp; Legend</h2>
<p>Country and province dropdowns are populated with names from the GAUL dataset, and their <code>onChange</code> events are linked to the filtering handlers defined earlier.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// F1: Dropdown Initialization &amp; Callbacks</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>countrySelect<span class="op">.</span><span class="fu">onChange</span>(onCountryChange)<span class="op">;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>provinceSelect<span class="op">.</span><span class="fu">onChange</span>(onProvinceChange)<span class="op">;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>countries<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">'ADM0_NAME'</span>)<span class="op">.</span><span class="fu">distinct</span>()<span class="op">.</span><span class="fu">sort</span>()<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(list) {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  countrySelect<span class="op">.</span><span class="fu">items</span>()<span class="op">.</span><span class="fu">reset</span>(list)<span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A map click event hides region‐selection panels, shows the statistics panel, and fetches the clicked hotspot’s properties from <code>enrichedHotspots</code> to populate detailed rows through <code>addInfoRow</code>. The legend is created at the end.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// F2: Interaction when clicking hotspot</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">onClick</span>(<span class="kw">function</span>(coords) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(regionPanel)<span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(descriptionPanel)<span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(infoPanel)<span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(statisticsPanel)<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">add</span>(statisticsPanel)<span class="op">;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">remove</span>(homeButton)<span class="op">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  mainPanel<span class="op">.</span><span class="fu">add</span>(homeButton)<span class="op">;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">remove</span>(sliderPanel)<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  statisticsPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  statisticsPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Hotspot Information loading...'</span><span class="op">,</span> { <span class="dt">fontStyle</span><span class="op">:</span> <span class="st">'italic'</span> }))<span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> pt <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([coords<span class="op">.</span><span class="at">lon</span><span class="op">,</span> coords<span class="op">.</span><span class="at">lat</span>])<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  enrichedHotspots<span class="op">.</span><span class="fu">filterBounds</span>(pt)<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(f) {</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    statisticsPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>f) {</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>      statisticsPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'No hotspot here.'</span>))<span class="op">;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>      statisticsPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Hotspot Info'</span><span class="op">,</span> { <span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'16px'</span> }))<span class="op">;</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Peak Season'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">peakSeason</span>))<span class="op">;</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Total Cranes'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">totalCranes</span>))<span class="op">;</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Reserve coverage (%)'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        (f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">reserveCoverage</span> <span class="op">!==</span> <span class="kw">null</span>) <span class="op">?</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">reserveCoverage</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">'%'</span> <span class="op">:</span> <span class="st">'N/A'</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">;</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Average NDVI'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        (f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">NDVI</span> <span class="op">!==</span> <span class="kw">null</span>) <span class="op">?</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">NDVI</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">3</span>) <span class="op">:</span> <span class="st">'N/A'</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">;</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Average Temp (°C)'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>        (f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">Temp</span> <span class="op">!==</span> <span class="kw">null</span>) <span class="op">?</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">Temp</span><span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>) <span class="op">:</span> <span class="st">'N/A'</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">;</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Average NO₂'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        (f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">NO2</span> <span class="op">!==</span> <span class="kw">null</span>) <span class="op">?</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Number</span>(f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">NO2</span>)<span class="op">.</span><span class="fu">toExponential</span>(<span class="dv">2</span>) <span class="op">:</span> <span class="st">'N/A'</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">;</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">addInfoRow</span>(<span class="st">'- Water Area (%)'</span><span class="op">,</span> ui<span class="op">.</span><span class="fu">Label</span>(</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>        (f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">WaterAreaFrac</span> <span class="op">!==</span> <span class="kw">null</span>) <span class="op">?</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Number</span>(f<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">WaterAreaFrac</span>)<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">1</span>) <span class="op">+</span> <span class="st">'%'</span> <span class="op">:</span> <span class="st">'N/A'</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>      ))<span class="op">;</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="co">// F3: Legend</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> legend <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">'bottom-right'</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">'8px'</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">'white'</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">'Legend'</span><span class="op">,</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">fontWeight</span><span class="op">:</span><span class="st">'bold'</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span><span class="st">'16px'</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span><span class="st">'0 0 4px 0'</span>}</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makeLegendSymbol</span>(fillColor<span class="op">,</span> borderColor<span class="op">,</span> name) {</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ui<span class="op">.</span><span class="fu">Panel</span>([</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">''</span><span class="op">,</span> {</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>      <span class="dt">backgroundColor</span><span class="op">:</span> fillColor<span class="op">,</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>      <span class="dt">padding</span><span class="op">:</span> <span class="st">'8px'</span><span class="op">,</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span>  <span class="st">'0 0 4px 0'</span><span class="op">,</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span>   <span class="st">'18px'</span><span class="op">,</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>      <span class="dt">height</span><span class="op">:</span>  <span class="st">'18px'</span><span class="op">,</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>      <span class="dt">border</span><span class="op">:</span>  <span class="st">'1px solid '</span> <span class="op">+</span> borderColor</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>    ui<span class="op">.</span><span class="fu">Label</span>(name<span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span><span class="st">'0 0 4px 6px'</span>})</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">'horizontal'</span>))<span class="op">;</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeLegendSymbol</span>(<span class="st">'#FF000088'</span><span class="op">,</span> <span class="st">'#FF0000'</span><span class="op">,</span> <span class="st">'Hotspots Outside Reserves'</span>))<span class="op">;</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeLegendSymbol</span>(<span class="st">'#ff8c0088'</span><span class="op">,</span> <span class="st">'#ff8c00'</span><span class="op">,</span> <span class="st">'Hotspots Inside or Partially Inside Reserves'</span>))<span class="op">;</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeLegendSymbol</span>(<span class="st">'#FFFFFF'</span><span class="op">,</span><span class="st">'#000000'</span><span class="op">,</span> <span class="st">'Migration Corridor'</span>))</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">add</span>(<span class="fu">makeLegendSymbol</span>(<span class="st">'rgba(0,100,0,0.53)'</span><span class="op">,</span> <span class="st">'#006400'</span><span class="op">,</span> <span class="st">'Nature Reserves'</span>))<span class="op">;</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(legend)<span class="op">;</span></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="co">// ========================= RUN APP =========================</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="fu">updateHotspotsFromSlider</span>(threshold_value)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="references" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> References</h1>
<p>Batbayar, N., Galtbalt, B., Natsagdorj, T., <em>et al.</em> (2024). <em>White-naped crane Mongolia WSCC</em> [Dataset]. Movebank Data Repository. https://doi.org/10.5441/001/1.600</p>
<p>Rose, D. C., Sutherland, W. J., Amano, T., <em>et al.</em> (2018). The major barriers to evidence-informed conservation policy and possible solutions. <em>Conservation Letters</em>, <em>11</em>(5), e12564. https://doi.org/10.1111/conl.12564</p>
<p>Runge, C. A., Martin, T. G., Possingham, H. P., <em>et al.</em> (2014). Conserving mobile species. <em>Frontiers in Ecology and the Environment</em>, <em>12</em>(7), 395–402. https://doi.org/10.1890/130237</p>
<p>Wilcove, D. S., &amp; Wikelski, M. (2008). Going, going, gone: Is animal migration disappearing? <em>PLoS Biology</em>, <em>6</em>(7), e188. https://doi.org/10.1371/journal.pbio.0060188</p>
<p>Yanco, S.W., Oliver, R.Y., Iannarilli, F., et al.&nbsp;(2024) Migratory birds modulate niche tradeoffs in rhythm with seasons and life history. Proceedings of the National Academy of Sciences, 121 (41): e2316827121. doi:10.1073/pnas.2316827121.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>